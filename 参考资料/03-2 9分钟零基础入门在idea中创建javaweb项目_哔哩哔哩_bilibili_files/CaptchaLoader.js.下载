!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).CaptchaLoader={})}(this,(function(e){"use strict";function n(){return n=Object.assign?Object.assign.bind():function(e){for(var n=1;n<arguments.length;n++){var o=arguments[n];for(var r in o)({}).hasOwnProperty.call(o,r)&&(e[r]=o[r])}return e},n.apply(null,arguments)}var o=function(e){"undefined"!=typeof window&&window.__BILI_X_ENGINE_SCRIPT_CACHE__&&void 0!==window.__BILI_X_ENGINE_SCRIPT_CACHE__[e]&&delete window.__BILI_X_ENGINE_SCRIPT_CACHE__[e]},r=function(e,n){if("undefined"==typeof window)return Promise.reject(new Error("window is not defined"));var r,t=e=e.replace(/^https?:\/\//,"//"),i=(r=t,"undefined"==typeof window?null:window.__BILI_X_ENGINE_SCRIPT_CACHE__&&window.__BILI_X_ENGINE_SCRIPT_CACHE__[r]||null);if(null!=i&&i.promise)return i.promise;var s=new Promise((function(o,r){var t=document.createElement("script");t.src=e,null!=n&&n.behavior&&t.setAttribute(n.behavior,""),t.onload=function(){var t=window;if(n.lib)return t[n.lib]?o(t[n.lib]):r(new Error('Failed to access library "'+n.lib+'" from '+e));o(null)},t.onerror=function(){r(new Error("Failed to load "+e)),document.head.removeChild(t)},document.head.appendChild(t)}));return function(e,n){"undefined"!=typeof window&&(window.__BILI_X_ENGINE_SCRIPT_CACHE__||(window.__BILI_X_ENGINE_SCRIPT_CACHE__={}),window.__BILI_X_ENGINE_SCRIPT_CACHE__[e]=n)}(t,{promise:s,lib:null==n?void 0:n.lib}),s.then((function(){!1===(null==n?void 0:n.cache)&&o(t)})).catch((function(){!1===(null==n?void 0:n.cache)&&o(t)})),s},t=function(e){return Promise.resolve(function(){try{return window.ReporterPb?Promise.resolve(window.ReporterPb):Promise.resolve(r("//s1.hdslb.com/bfs/seed/jinkela/short/reporter-pb/index.js",{lib:"ReporterPb"}))}catch(e){return Promise.reject(e)}}()).then((function(n){return new n(e)}))},i=function(e){var o=e.type,r=e.event,t=e.msg;try{var i=function(){a.tech(r,n({type:o},t))};r=r.split(".").length<2?r+=".0":r,r="".concat(c,".").concat(r);var u=function(){if(!a)return Promise.resolve(s()).then((function(){}))}();return Promise.resolve(u&&u.then?u.then(i):i())}catch(e){return Promise.reject(e)}},s=function(){try{return f||(f=t({spmPrefix:c,sampleRate:1,autoPv:!1,batch:{batchSize:10,batchTime:500},feature:{tech:!0}}).then((function(e){return a=e}))),Promise.resolve(f)}catch(e){return Promise.reject(e)}},c="333.1268",u=function(){var e,n=null===(e=document.getElementsByTagName("meta").spm_prefix)||void 0===e?void 0:e.content;return n?n+".0.0":"0.0.0.0"},l={},d={},a=null,f=null;function _(e){l[e]=Date.now()}function w(e,n){if(l[e]){var o=Date.now()-l[e];!function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"custom";(n=Object.assign({},d,n)).businessSpmid||(n.businessSpmid=u()),i({type:o,event:e,msg:n})}(e,Object.assign({time:o},n)),delete l[e]}}function m(e,n){try{var o=e()}catch(e){return n(e)}return o&&o.then?o.then(void 0,n):o}var h=function(e){try{if(window._loadLogicPromise_)return Promise.resolve(window._loadLogicPromise_);return window._loadLogicPromise_=function(){try{return Promise.resolve(m((function(){return _("logic"),Promise.resolve(function(e){return new Promise((function(n,o){var r=document.createElement("script");r.src=e,r.onload=function(){n()},r.onerror=function(){o()},document.body.appendChild(r)}))}(e)).then((function(){var e=window.useCaptcha;return delete window.useCaptcha,w("logic",{result:"success"}),e}))}),(function(){throw window._loadLogicPromise_=null,w("logic",{result:"failure",url:e}),new Error("加载脚本失败")})))}catch(e){return Promise.reject(e)}}(),Promise.resolve(window._loadLogicPromise_)}catch(e){return Promise.reject(e)}},P=function(){try{if(window._loadConfigPromise_)return Promise.resolve(window._loadConfigPromise_);return window._loadConfigPromise_=function(){try{return Promise.resolve(m((function(){return _("config"),Promise.resolve(function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{method:"GET",headers:{}},o=n.method,r=n.headers,t=n.data;return new Promise((function(n,i){var s=new XMLHttpRequest;for(var c in s.onreadystatechange=function(){if(4===this.readyState&&200===this.status)try{n(JSON.parse(this.response||this.responseText))}catch(e){n(this.response||this.responseText)}else 4===this.readyState&&i()},s.onerror=i,s.ontimeout=i,s.withCredentials=!0,s.open(o,e),r)s.setRequestHeader(c,r[c]);s.send(t)}))}(v)).then((function(e){return w("config",{result:"success"}),e}))}),(function(){throw window._loadConfigPromise_=null,w("config",{result:"failure"}),new Error("加载配置失败")})))}catch(e){return Promise.reject(e)}}(),Promise.resolve(window._loadConfigPromise_)}catch(e){return Promise.reject(e)}},v="//api.bilibili.com/x/web-frontend/risk/config";window._loadConfigPromise_=window._loadConfigPromise_||null,window._loadLogicPromise_=window._loadLogicPromise_||null,e.load=function(){return Promise.resolve(P()).then((function(e){var n=e.logic;return h(n)}))}}));
